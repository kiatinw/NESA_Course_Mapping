<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NESA Course Mapping Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .step {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .step.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .step.complete {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 18px;
        }

        .step.complete .step-number {
            background: #4caf50;
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .file-upload {
            margin: 15px 0;
        }

        .file-upload label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        input[type="file"] {
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            max-width: 400px;
        }

        input[type="file"]:hover {
            border-color: #667eea;
        }

        .file-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }

        .file-status.success {
            display: block;
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .file-status.error {
            display: block;
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }

        .mapping-container {
            margin-top: 20px;
        }

        .mapping-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mapping-label {
            font-weight: 600;
            min-width: 150px;
            color: #333;
            font-size: 16px;
        }

        .mapping-select {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            max-width: 500px;
        }

        .mapping-select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .unmapped-list {
            margin-top: 15px;
            padding: 15px;
            background: #fff3e0;
            border-radius: 6px;
            border: 1px solid #ff9800;
        }

        .unmapped-list h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .unmapped-list ul {
            margin-left: 20px;
        }

        .unmapped-list li {
            color: #f57c00;
            margin: 5px 0;
        }

        .progress-info {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .match-item {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .match-item.matched {
            border-left: 4px solid #4caf50;
        }

        .match-item.unmatched {
            border-left: 4px solid #ff9800;
        }

        .match-column {
            display: flex;
            flex-direction: column;
        }

        .match-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .match-value {
            font-size: 14px;
            color: #333;
        }

        .match-arrow {
            text-align: center;
            font-size: 20px;
            color: #4caf50;
        }

        .match-arrow.unmatched {
            color: #ff9800;
        }

        .match-select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
        }

        .match-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .match-stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
        }

        .stat-item.success {
            background: #e8f5e9;
        }

        .stat-item.warning {
            background: #fff3e0;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“š NESA Course Mapping Tool</h1>
            <p>Map student enrolments to NESA course codes</p>
        </div>

        <div class="content">
            <!-- STEP 1: Upload Student Enrolments -->
            <div class="step active" id="step1">
                  <div class="step-header">
                      <div class="step-number">1</div>
                      <div class="step-title">Upload Student Attendance Spreadsheet</div>
                  </div>
              
                 <ul class="step-instructions">
                     <li>Go to the <b>Profiles</b> module on Sentral.</li>
                     <li>Select <b>Exports</b> in the menu on the left.</li>
                     <li>Match the settings as shown below. Make sure you have selected only the desired year.</li>
                    <li>Only .xls or .xlsx files are accepted. Do not modify the spreadsheet once downloaded from Sentral.</li>
                 </ul>

                <style>
                    .instruction-image {
                        text-align: center;
                        margin: 15px 0;
                    }
                
                    .instruction-image img {
                        max-width: 600px;
                        width: 100%;
                        border: 1px solid #ccc;
                        border-radius: 6px;
                        display: inline-block;
                    }
                </style>


                 <div class="instruction-image">
                       <img src="SentralSettings.png" alt="Sentral export settings screenshot" />
                 </div>
             
              
                  <div class="file-upload">
                      <label for="studentFile">Select student attendance file (.xls or .xlsx):</label>
                      <input type="file" id="studentFile" accept=".xls,.xlsx" />
                      <div class="file-status" id="studentStatus"></div>
                  </div>
              
                  <div class="progress-info" id="studentProgress"></div>
              </div>


            <!-- STEP 2: Upload NESA Course Codes -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Upload NESA Course Codes</div>
                </div>
            
                <ul class="step-instructions">
                    <li>In Schools Online, go to <b>Courses Offered at Your School</b>.</li>
                    <li>Change the year of study to the one you are working with.</li>
                    <li>Select <b>Show only courses offered</b>. This will show courses offered at your school and make matching easier.</li>
                    <li>Click on the download button. Do not make any changes to the file.</li>
                </ul>
            
                <div class="file-upload">
                    <label for="courseFile">Select NESA course codes file (.csv):</label>
                    <input type="file" id="courseFile" accept=".csv" />
                    <div class="file-status" id="courseStatus"></div>
                </div>
            
                <div class="progress-info" id="courseProgress"></div>
            </div>


            <!-- STEP 3: Upload NESA Template -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Upload NESA Template</div>
                </div>
            
                <ul class="step-instructions">
                    <li>In Schools Online, go to <b>20XX Enrolments</b>. </li>
                    <li>Select <b>Load Student Courses from a file</b>.</li>
                    <li>Make sure the correct year of study is selected.</li>
                    <li>On the left, click on <b>create entry file</b> to download the file. Do not make any changes to the file.</li>
                </ul>
            
                <div class="file-upload">
                    <label for="nesaStudentFile">Select NESA student data file (.csv):</label>
                    <input type="file" id="nesaStudentFile" accept=".csv" />
                    <div class="file-status" id="nesaStudentStatus"></div>
                </div>
            
                <div class="progress-info" id="nesaStudentProgress"></div>
            
                <div id="matchingContainer" class="hidden">
                    <div class="info-box" style="margin-top: 20px;">
                        Review automatic matches below. Unmatched students can be manually matched using the dropdowns.
                    </div>
                    <div id="matchingList"></div>
                    <button id="confirmMatchingBtn" onclick="confirmMatching()" style="margin-top: 20px;">
                        Confirm Matching & Continue
                    </button>
                </div>
            </div>


            <!-- STEP 4: Map Classes to Courses -->
            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Map Classes to NESA Courses</div>
                </div>
                <div class="info-box">
                    Map each unique class code to its corresponding NESA course. Unmapped classes will retain their original names in the output. You will need to manually map any courses that were not automatically matched, and any Board Endorsed courses.
                </div>
                
                <!-- Year Level Selector -->
                <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        ðŸ“… Select Year Level (for auto-mapping):
                    </label>
                    <div style="display: flex; gap: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="yearLevel" value="10" id="year10" style="margin-right: 8px;">
                            <span>Year 10</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="yearLevel" value="11" id="year11" checked style="margin-right: 8px;">
                            <span>Year 11</span>
                        </label>
                    </div>
                    <button onclick="rerunAutoMapping()" style="margin-top: 10px; padding: 8px 20px; font-size: 14px;">
                        ðŸ”„ Re-run Auto-Mapping
                    </button>
                </div>
                
                <div class="mapping-container" id="mappingContainer"></div>
                <button id="generateBtn" onclick="generateOutput()" disabled>Generate Output Spreadsheet</button>
            </div>

            <!-- STEP 5: Download Output -->
            <div class="step" id="step5">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <div class="step-title">Download Output</div>
                </div>

                <p>
                    Columns C, D and E are from the Sentral Attendance spreadsheet and are there for you to double check that the matching was done correctly. It is very important to check students with <i>common or duplicate surnames</i>. To upload this spreadsheet to Schools Online,
                </p>
                
                <ul class="step-instructions">
                    <li>Delete any students who do not have a NESA number. If you upload without doing this, Schools Online will get upset.</li>
                    <li>Delete columns C, D and E.</li>
                    <li>Do a final check for any courses that are still timetable codes instead of NESA codes.</li>
                    <li>Make sure the file is still a csv.</li>
                </ul>
                
                
                <div id="outputContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let studentData = null;
        let courseCodes = [];
        let nesaStudents = [];
        let studentMatching = {}; // Maps enrolment student index to NESA student index
        let uniqueClasses = [];
        let classMapping = {};

        // Step 1: Handle student enrolments upload
        document.getElementById('studentFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    // Process student data
                    studentData = processStudentData(jsonData);
                    
                    // Extract unique class names
                    uniqueClasses = extractUniqueClasses(studentData);
                    
                    // Show success
                    const status = document.getElementById('studentStatus');
                    status.className = 'file-status success';
                    status.textContent = `âœ“ Loaded ${studentData.students.length} students with ${uniqueClasses.length} unique classes`;
                    
                    const progress = document.getElementById('studentProgress');
                    progress.textContent = `Unique classes found: ${uniqueClasses.join(', ')}`;
                    
                    // Mark step complete and activate next
                    document.getElementById('step1').classList.add('complete');
                    document.getElementById('step2').classList.add('active');
                    
                } catch (error) {
                    const status = document.getElementById('studentStatus');
                    status.className = 'file-status error';
                    status.textContent = 'âœ— Error reading file: ' + error.message;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Step 2: Handle course codes upload
        document.getElementById('courseFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    try {
                        courseCodes = results.data
                                .filter(row => row['Course Number'] && row['Course Name'])
                                .map(row => ({
                                    number: row['Course Number'].trim(),
                                    name: row['Course Name'].trim(),
                                    hours: row['Number of hours'] ? parseInt(row['Number of hours'].trim()) : null
                                }));

                        
                        const status = document.getElementById('courseStatus');
                        status.className = 'file-status success';
                        status.textContent = `âœ“ Loaded ${courseCodes.length} NESA courses`;
                        
                        // Mark step complete and activate NESA student upload
                        document.getElementById('step2').classList.add('complete');
                        document.getElementById('step3').classList.add('active');
                        
                    } catch (error) {
                        const status = document.getElementById('courseStatus');
                        status.className = 'file-status error';
                        status.textContent = 'âœ— Error reading file: ' + error.message;
                    }
                },
                error: function(error) {
                    const status = document.getElementById('courseStatus');
                    status.className = 'file-status error';
                    status.textContent = 'âœ— Error parsing CSV: ' + error.message;
                }
            });
        });

        // Step 3: Handle NESA student data upload
        document.getElementById('nesaStudentFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    try {
                        nesaStudents = results.data
                            .filter(row => row['NESA Student Id'] && row['Student Name'])
                            .map((row, index) => ({
                                originalIndex: index,
                                nesaId: row['NESA Student Id'].trim(),
                                name: row['Student Name'].trim(),
                                courses: [
                                    row['Course 1'], row['Course 2'], row['Course 3'], row['Course 4'], row['Course 5'],
                                    row['Course 6'], row['Course 7'], row['Course 8'], row['Course 9'], row['Course 10']
                                ].filter(c => c && c.trim())
                            }));
                        
                        const status = document.getElementById('nesaStudentStatus');
                        status.className = 'file-status success';
                        status.textContent = `âœ“ Loaded ${nesaStudents.length} NESA students`;
                        
                        // Perform automatic matching
                        performAutomaticMatching();
                        
                        // Show matching interface
                        document.getElementById('matchingContainer').classList.remove('hidden');
                        
                    } catch (error) {
                        const status = document.getElementById('nesaStudentStatus');
                        status.className = 'file-status error';
                        status.textContent = 'âœ— Error reading file: ' + error.message;
                    }
                },
                error: function(error) {
                    const status = document.getElementById('nesaStudentStatus');
                    status.className = 'file-status error';
                    status.textContent = 'âœ— Error parsing CSV: ' + error.message;
                }
            });
        });

        function performAutomaticMatching() {
            studentMatching = {};
            
            studentData.students.forEach((student, enrolIndex) => {
                // Parse enrolment name
                const enrolSurname = student.surname.trim().toLowerCase();
                const enrolFirstName = student.givenNames.trim().split(/\s+/)[0].toLowerCase(); // Get first word of given names
                
                // Try to find match in NESA data
                const matchIndex = nesaStudents.findIndex(nesaStudent => {
                    // Parse NESA name (format: "SURNAME, First Name")
                    const parts = nesaStudent.name.split(',');
                    if (parts.length !== 2) return false;
                    
                    const nesaSurname = parts[0].trim().toLowerCase();
                    const nesaFirstName = parts[1].trim().split(/\s+/)[0].toLowerCase(); // Get first word
                    
                    return nesaSurname === enrolSurname && nesaFirstName === enrolFirstName;
                });
                
                if (matchIndex !== -1) {
                    studentMatching[enrolIndex] = matchIndex;
                }
            });
            
            // Generate matching interface
            generateMatchingInterface();
        }

        function generateMatchingInterface() {
            const container = document.getElementById('matchingList');
            container.innerHTML = '';
            
            // Calculate stats
            const matchedCount = Object.keys(studentMatching).length;
            const unmatchedCount = studentData.students.length - matchedCount;
            
            // Add stats display with toggle button
            const statsWrapper = document.createElement('div');
            const stats = document.createElement('div');
            stats.className = 'match-stats';
            stats.innerHTML = `
                <div class="stat-item success">
                    <div class="stat-number" style="color: #2e7d32;">${matchedCount}</div>
                    <div class="stat-label">Automatically Matched</div>
                </div>
                <div class="stat-item warning">
                    <div class="stat-number" style="color: #e65100;">${unmatchedCount}</div>
                    <div class="stat-label">Need Manual Matching</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" style="color: #666;">${studentData.students.length}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            `;
            statsWrapper.appendChild(stats);
            
            // Add toggle button
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = 'ðŸ‘ï¸ Hide Matched Students';
            toggleBtn.style.marginTop = '10px';
            toggleBtn.id = 'toggleMatchedBtn';
            let showMatched = true;
            
            toggleBtn.onclick = function() {
                showMatched = !showMatched;
                const matchedItems = document.querySelectorAll('.match-item.matched');
                matchedItems.forEach(item => {
                    item.style.display = showMatched ? 'grid' : 'none';
                });
                toggleBtn.textContent = showMatched ? 'ðŸ‘ï¸ Hide Matched Students' : 'ðŸ‘ï¸ Show Matched Students';
            };
            
            statsWrapper.appendChild(toggleBtn);
            container.appendChild(statsWrapper);
            
            // Sort students: unmatched first, then matched
            const sortedStudents = studentData.students.map((student, index) => ({
                student,
                index,
                isMatched: studentMatching.hasOwnProperty(index)
            })).sort((a, b) => {
                // Unmatched (false) comes before matched (true)
                if (a.isMatched === b.isMatched) return 0;
                return a.isMatched ? 1 : -1;
            });
            
            // Generate matching items for each student
            sortedStudents.forEach(({ student, index: enrolIndex, isMatched }) => {
                const item = document.createElement('div');
                item.className = `match-item ${isMatched ? 'matched' : 'unmatched'}`;
                
                const enrolName = `${student.surname}, ${student.givenNames}`;
                const enrolId = student.studentId;
                
                // Left column: Enrolment data
                const leftCol = document.createElement('div');
                leftCol.className = 'match-column';
                leftCol.innerHTML = `
                    <div class="match-label">Enrolment File</div>
                    <div class="match-value"><strong>${enrolName}</strong></div>
                    <div class="match-value" style="font-size: 12px; color: #666;">ID: ${enrolId}</div>
                `;
                
                // Arrow
                const arrow = document.createElement('div');
                arrow.className = `match-arrow ${isMatched ? '' : 'unmatched'}`;
                arrow.textContent = isMatched ? 'âœ“ â†’' : '? â†’';
                
                // Right column: NESA match dropdown
                const rightCol = document.createElement('div');
                rightCol.className = 'match-column';
                rightCol.innerHTML = `<div class="match-label">NESA Student</div>`;
                
                const select = document.createElement('select');
                select.className = 'match-select';
                select.id = `match_${enrolIndex}`;
                
                // Add "No match" option
                const noMatchOption = document.createElement('option');
                noMatchOption.value = '';
                noMatchOption.textContent = '-- No NESA match --';
                select.appendChild(noMatchOption);
                
                // Add all NESA students as options
                nesaStudents.forEach((nesaStudent, nesaIndex) => {
                    const option = document.createElement('option');
                    option.value = nesaIndex;
                    option.textContent = `${nesaStudent.name} (${nesaStudent.nesaId})`;
                    if (isMatched && studentMatching[enrolIndex] === nesaIndex) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Update matching when selection changes
                select.addEventListener('change', function() {
                    if (this.value === '') {
                        delete studentMatching[enrolIndex];
                        item.className = 'match-item unmatched';
                        arrow.className = 'match-arrow unmatched';
                        arrow.textContent = '? â†’';
                    } else {
                        studentMatching[enrolIndex] = parseInt(this.value);
                        item.className = 'match-item matched';
                        arrow.className = 'match-arrow';
                        arrow.textContent = 'âœ“ â†’';
                    }
                    // Update stats
                    generateMatchingInterface();
                });
                
                rightCol.appendChild(select);
                
                // Status column
                const statusCol = document.createElement('div');
                statusCol.className = 'match-column';
                if (isMatched) {
                    const nesaStudent = nesaStudents[studentMatching[enrolIndex]];
                    statusCol.innerHTML = `
                        <div class="match-value" style="color: #2e7d32; font-weight: 600;">âœ“ Matched</div>
                        <div class="match-value" style="font-size: 11px; color: #666;">NESA ID: ${nesaStudent.nesaId}</div>
                    `;
                } else {
                    statusCol.innerHTML = `
                        <div class="match-value" style="color: #e65100; font-weight: 600;">âš  Needs Review</div>
                        <div class="match-value" style="font-size: 11px; color: #666;">Select NESA student</div>
                    `;
                }
                
                item.appendChild(leftCol);
                item.appendChild(arrow);
                item.appendChild(rightCol);
                item.appendChild(statusCol);
                container.appendChild(item);
            });
        }

        function confirmMatching() {
            // Mark step complete and activate class mapping
            document.getElementById('step3').classList.add('complete');
            document.getElementById('step4').classList.add('active');
            
            // Generate mapping interface
            generateMappingInterface();
            
            // Scroll to mapping section
            document.getElementById('step4').scrollIntoView({ behavior: 'smooth' });
        }

        function performAutomaticClassMapping() {
            // Get selected year level
            const year10Selected = document.getElementById('year10').checked;
            const year11Selected = document.getElementById('year11').checked;
            
            // School-specific subject codes and their NESA course keywords
            // Pattern: First letter = Faculty, remaining letters = Subject
            const mappingHints = {
                // Mathematics (M faculty)
                'MMA': ['mathematics advanced', 'advanced mathematics'],
                'MMS': ['mathematics standard', 'standard mathematics'],
                // MMX is Year 11 only (Mathematics Extension)
                'MMX': ['mathematics extension', 'extension mathematics'],
                'MXX': ['extension 2 mathematics', 'mathematics extension 2'],
                
                // English (E faculty)
                'EEN': ['english', 'standard english', 'advanced english'],
                'ENA': ['advanced english', 'english advanced'],
                'ENS': ['standard english', 'english standard'],
                // ENX is Year 11 only (English Extension)
                'ENX': ['english extension', 'extension english'],
                'EXX': ['extension 2 english', 'english extension 2'],
                'ESL': ['english EAL/D', 'esl'],
                'EDR': ['drama'],
                'ESD': ['english studies'],
                
                // Science (S faculty)
                'SPH': ['physics'],
                'SCH': ['chemistry'],
                'SBI': ['biology'],
                'SSC': ['investigating science'],
                'SEE': ['earth and environmental science', 'earth environmental'],
                'SIS': ['investigating science'],
                
                // HSIE (H faculty)
                'HBS': ['business studies'],
                'HLS': ['legal studies'],
                'HAH': ['ancient history'],
                'HMH': ['modern history', 'history'],
                'HGE': ['geography'],
                'HEC': ['economics'],
                'HSC': ['society and culture'],
                'PCF': ['community and family studies'],
                'HWS': ['work studies'],
                
                // CAPA (C faculty - Creative & Performing Arts)
                'CVA': ['visual arts', 'art'],
                'CMU': ['music'],
                'PDA': ['dance'],
                'CDR': ['drama'],
                
                // TAS (T faculty - Technology & Applied Studies)
                'TDT': ['design and technology'],
                'TFT': ['food technology'],
                'TMM': ['multimedia'],
                'TTX': ['textiles and design'],
                'TSE': ['software engineering', 'software'],
                'TIM': ['information processes', 'ipt'],
                'TCO': ['construction'],
                'TES': ['engineering studies'],
                'TEC': ['enterprise computing'],
                
                // PDHPE (P faculty)
                'PHS': ['health'],
                'PSP': ['sport lifestyle', 'sports'],
                
                // Languages (L faculty)
                'LFB': ['french beginners'],
                'LFC': ['french continuers'],
                'LSB': ['spanish beginners'],
                'LSC': ['spanish continuers'],
                'LGE': ['german'],
                'LJB': ['japanese beginners'],
                'LJC': ['japanese continuers'],
                'LCH': ['chinese'],
                'LIT': ['italian'],
                'LLA': ['latin'],
                'LIN': ['indonesian'],
                'LAR': ['arabic'],
                
                // VET subjects (V faculty)
                'VET': ['vocational', 'vet'],
                'VBU': ['business services'],
                'VCO': ['construction'],
                'VEN': ['entertainment'],
                'VHO': ['hospitality'],
                'VIT': ['information technology'],
                'VRE': ['retail'],
                
                // Other
                'REL': ['studies of religion', 'religion'],
                'SOR': ['studies of religion', 'religion'],
                'PHO': ['photography']
            };
            
            // Try to auto-map each class
            uniqueClasses.forEach(className => {
                let hints = null;
                const classUpper = className.toUpperCase();
                
                // Special handling for Extension courses (only available in Year 11)
                if ((classUpper === 'MMX' || classUpper === 'ENX') && year10Selected) {
                    // These courses don't exist in Year 10, skip auto-mapping
                    return;
                }
                
                // Normal lookup
                hints = mappingHints[classUpper];
                
                if (!hints) return;
                
                // Find potential matches
                let potentialMatches = [];
                courseCodes.forEach(course => {
                    const courseName = course.name.toLowerCase();
                    let score = 0;
                    hints.forEach(hint => {
                        if (courseName.includes(hint.toLowerCase())) score += hint.length;
                    });
                    if (score > 0) potentialMatches.push({ course, score });
                });
                
                let bestMatch = null;
            
                if (year10Selected) {
                    // Year 10: prefer 200-hour courses
                    const matches200 = potentialMatches.filter(m => m.course.hours === 200);
                    if (matches200.length > 0) {
                        matches200.sort((a,b) => b.score - a.score);
                        bestMatch = matches200[0].course.number;
                    } else if (potentialMatches.length > 0) {
                        potentialMatches.sort((a,b) => b.score - a.score);
                        bestMatch = potentialMatches[0].course.number;
                    }
                } else {
    // Year 11: prefer non-Life Skills courses
    const nonLifeSkills = potentialMatches.filter(m => !m.course.name.toLowerCase().includes('life skills'));
    
    if (nonLifeSkills.length > 0) {
        nonLifeSkills.sort((a,b) => b.score - a.score);
        bestMatch = nonLifeSkills[0].course.number;
    } else if (potentialMatches.length > 0) {
        // fallback to Life Skills if no other match
        potentialMatches.sort((a,b) => b.score - a.score);
        bestMatch = potentialMatches[0].course.number;
    }
}

                
                // Store mapping
                if (bestMatch) {
                    if (!window.autoMappings) window.autoMappings = {};
                    window.autoMappings[className] = bestMatch;
                }
            });

        }

        function rerunAutoMapping() {
            // Clear previous auto-mappings
            window.autoMappings = {};
        
            // Re-run auto-mapping for the selected year level
            performAutomaticClassMapping();
        
            // Re-generate the mapping interface (dropdowns + info box)
            generateMappingInterface();
        }


        function processStudentData(jsonData) {
            const headers = jsonData[0];
            const students = [];
            
            // Find column indices
            const surnameIdx = headers.findIndex(h => h && h.toLowerCase().includes('surname'));
            const givenNameIdx = headers.findIndex(h => h && h.toLowerCase().includes('given'));
            const studentIdIdx = headers.findIndex(h => h && h.toLowerCase().includes('student id'));
            
            // Find class columns (skip attendance columns)
            const classColumns = [];
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i];
                if (header && header.toLowerCase().includes('class') && !header.toLowerCase().includes('attendance')) {
                    classColumns.push(i);
                }
            }
            
            // Process each student row
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row[surnameIdx]) continue; // Skip empty rows
                
                const student = {
                    surname: row[surnameIdx] || '',
                    givenNames: row[givenNameIdx] || '',
                    studentId: row[studentIdIdx] || '',
                    classes: []
                };
                
                // Extract classes (max 12)
                for (let j = 0; j < Math.min(classColumns.length, 12); j++) {
                    const classValue = row[classColumns[j]];
                    if (classValue && classValue.toString().trim()) {
                        student.classes.push(classValue.toString().trim());
                    }
                }
                
                students.push(student);
            }
            
            return { students, maxClasses: 12 };
        }

            function extractUniqueClasses(studentData) {
                const classSet = new Set();
                
                studentData.students.forEach(student => {
                    student.classes.forEach(className => {
                        // Take characters 3, 4, 5 (zero-based index 2,3,4)
                        const cleanedClass = className.length >= 5 ? className.substring(2, 5).toUpperCase() : className.toUpperCase();
                        classSet.add(cleanedClass);
                    });
                });
                
                return Array.from(classSet).sort();
            }


        function generateMappingInterface() {
            const container = document.getElementById('mappingContainer');
            container.innerHTML = '';
            
            // Perform automatic mapping first
            performAutomaticClassMapping();
            
            uniqueClasses.forEach(className => {
                  const item = document.createElement('div');
                  item.className = 'mapping-item';
                  item.style.display = 'flex';
                  item.style.alignItems = 'center';
                  item.style.gap = '12px';
              
                  // Label
                  const label = document.createElement('div');
                  label.className = 'mapping-label';
                  label.textContent = className;
              
                  // Dropdown
                  const select = document.createElement('select');
                  select.className = 'mapping-select';
                  select.id = `mapping_${className}`;
              
                  const defaultOption = document.createElement('option');
                  defaultOption.value = '';
                  defaultOption.textContent = '-- Leave as ' + className + ' (unmapped) --';
                  select.appendChild(defaultOption);
              
                  courseCodes.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.number;
                        
                        let text = `${course.name} (${course.number})`;
                        if (course.hours) {
                            text += ` â€“ ${course.hours} hrs`; // Always show hours if present
                        }
                        option.textContent = text;

                    
                        if (window.autoMappings && window.autoMappings[className] === course.number) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });

              
                  // Delete checkbox
                  const deleteWrapper = document.createElement('label');
                  deleteWrapper.style.display = 'flex';
                  deleteWrapper.style.alignItems = 'center';
                  deleteWrapper.style.gap = '6px';
                  deleteWrapper.style.fontSize = '13px';
                  deleteWrapper.style.cursor = 'pointer';
              
                  const deleteCheckbox = document.createElement('input');
                  deleteCheckbox.type = 'checkbox';
                  deleteCheckbox.id = `delete_${className}`;
                  deleteWrapper.appendChild(deleteCheckbox);
                  deleteWrapper.appendChild(document.createTextNode('Delete'));
              
                  // Manual course code input
                  const manualInput = document.createElement('input');
                  manualInput.type = 'text';
                  manualInput.id = `manual_${className}`;
                  manualInput.placeholder = 'Enter course code manually';
                  manualInput.style.padding = '6px';
                  manualInput.style.border = '2px solid #ddd';
                  manualInput.style.borderRadius = '6px';
                  manualInput.style.width = '140px';
              
                  // Function to update highlight & live mapping
                  function updateHighlight() {
                        if (deleteCheckbox.checked) {
                            item.style.background = '#ffebee'; // Red for deleted
                            classMapping[className] = '';      // Deleted
                        } else if (manualInput.value.trim()) {
                            item.style.background = '#e8f5e9'; // Green for manual entry
                            classMapping[className] = manualInput.value.trim();
                            select.value = ''; // Clear dropdown so it doesn't conflict
                        } else if (select.value) {
                            item.style.background = '#e8f5e9'; // Green for dropdown mapped
                            classMapping[className] = select.value;
                        } else {
                            item.style.background = '#fff3e0'; // Orange for unmapped
                            classMapping[className] = className;
                        }
                    }

              
                  // Event listeners
                  select.addEventListener('change', () => {
                      if (select.value) manualInput.value = '';
                      updateHighlight();
                  });
                  deleteCheckbox.addEventListener('change', () => {
                      if (deleteCheckbox.checked) manualInput.value = '';
                      updateHighlight();
                  });
                  manualInput.addEventListener('input', () => {
                      if (manualInput.value.trim()) select.value = '';
                      updateHighlight();
                  });
              
                  updateHighlight(); // Initial highlight & live mapping
              
                  item.appendChild(label);
                  item.appendChild(select);
                  item.appendChild(deleteWrapper);
                  item.appendChild(manualInput);
                  container.appendChild(item);
              });

            
            // Count and show auto-mapping results
            const autoMappedCount = uniqueClasses.filter(className => {
                return window.autoMappings && window.autoMappings[className];
            }).length;
            
            if (autoMappedCount > 0) {
                const info = document.createElement('div');
                info.className = 'info-box';
                info.style.marginTop = '20px';
                info.innerHTML = `âœ“ Automatically pre-selected ${autoMappedCount} of ${uniqueClasses.length} class mappings based on course names. Please review and adjust as needed.`;
                container.appendChild(info);
            }
            
            // Enable generate button
            document.getElementById('generateBtn').disabled = false;
        }

        function generateOutput() {
            // Collect mappings
            classMapping = {};
            const deletedClasses = new Set();
            manuallyOverriddenClasses = new Set(); // Reset manual overrides for this run
            
            // Track deleted classes
            uniqueClasses.forEach(className => {
                const deleteCheckbox = document.getElementById(`delete_${className}`);
                if (deleteCheckbox && deleteCheckbox.checked) {
                    deletedClasses.add(className);
                }
            });
        
            // Build classMapping and track manual overrides
            uniqueClasses.forEach(className => {
                const select = document.getElementById(`mapping_${className}`);
                const manualInput = document.getElementById(`manual_${className}`);
                
                if (manualInput && manualInput.value.trim()) {
                    classMapping[className] = manualInput.value.trim();
                    manuallyOverriddenClasses.add(className);
                } else if (select && select.value) {
                    classMapping[className] = select.value;
                } else {
                    classMapping[className] = className; // unmapped
                }
            });
        
            // Prepare output
            const outputData = [];
            const unmappedClasses = new Set();
            const unmatchedStudents = [];
        
            // Header row
            const headers = [
                'NESA Student ID',
                'Student Name (NESA)',
                'Surname (Enrolment)',
                'Given Names (Enrolment)',
                'Student ID (Enrolment)'
            ];
            for (let i = 1; i <= studentData.maxClasses; i++) {
                headers.push(`Class ${i}`);
            }
            outputData.push(headers);
        
            // Process students
            studentData.students.forEach((student, enrolIndex) => {
                const row = [];
        
                // Check NESA match
                if (studentMatching.hasOwnProperty(enrolIndex)) {
                    const nesaStudent = nesaStudents[studentMatching[enrolIndex]];
                    row.push(nesaStudent.nesaId);
                    row.push(nesaStudent.name);
                } else {
                    row.push('');
                    row.push('');
                    unmatchedStudents.push(`${student.surname}, ${student.givenNames} (ID: ${student.studentId})`);
                }
        
                // Enrolment info
                row.push(student.surname);
                row.push(student.givenNames);
                row.push(student.studentId);
        
                // Classes
                for (let i = 0; i < studentData.maxClasses; i++) {
                    if (i < student.classes.length) {
                        const originalClass = student.classes[i];
                        const cleanedClass = originalClass.length >= 5 ? originalClass.substring(2, 5).toUpperCase() : originalClass.toUpperCase();
                        let mappedValue = '';
        
                        if (!deletedClasses.has(cleanedClass)) {
                            mappedValue = classMapping[cleanedClass];
                            if (mappedValue === cleanedClass) {
                                unmappedClasses.add(cleanedClass);
                            }
                        }
        
                        row.push(mappedValue);
                    } else {
                        row.push('');
                    }
                }
        
                outputData.push(row);
            });
        
            // Generate workbook and download
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(outputData);
            XLSX.utils.book_append_sheet(wb, ws, 'Mapped Students');
            XLSX.writeFile(wb, 'NESA_Mapped_Students.csv', { bookType: 'csv' });
        
            // Mark step complete
            document.getElementById('step4').classList.add('complete');
            document.getElementById('step5').classList.add('active');
        
            // Build report message
            const outputContainer = document.getElementById('outputContainer');
            let message = '<div class="info-box">âœ“ Output file generated and downloaded successfully!</div>';
        
            // Unmatched students
            if (unmatchedStudents.length > 0) {
                message += '<div class="unmapped-list"><h4>âš ï¸ Unmatched Students</h4>';
                message += '<p>The following students from the enrolment file were not matched to NESA data:</p><ul>';
                unmatchedStudents.forEach(studentName => {
                    message += `<li>${studentName}</li>`;
                });
                message += '</ul></div>';
            }
        
            // Unmapped classes
            if (unmappedClasses.size > 0) {
                message += '<div class="unmapped-list"><h4>âš ï¸ Unmapped Classes</h4>';
                message += '<p>The following classes were not mapped and retained their original names:</p><ul>';
                Array.from(unmappedClasses).forEach(className => {
                    message += `<li>${className}</li>`;
                });
                message += '</ul></div>';
            }
        
            // Manually overridden classes
            const overriddenClasses = Array.from(manuallyOverriddenClasses).sort();
            if (overriddenClasses.length > 0) {
                message += '<div class="unmapped-list"><h4>âœï¸ Manually Overridden Classes</h4>';
                message += '<p>The following classes were manually changed from their auto-mapped value:</p><ul>';
                overriddenClasses.forEach(className => {
                    const mappedValue = classMapping[className];
                    message += `<li>${className} â†’ ${mappedValue}</li>`;
                });
                message += '</ul></div>';
            }
        
            message += '<button onclick="location.reload()">Start New Mapping</button>';
            outputContainer.innerHTML = message;
        }

    </script>
</body>
</html>
