<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NESA Course Mapping Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #6495ED 0%, #4169E1 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6495ED 0%, #4169E1 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .faq-button {
            position: absolute;
            top: 20px;
            right: 30px;
            background: white;
            color: #4169E1;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .faq-button:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .content {
            padding: 30px;
        }

        .step {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .step.active {
            border-color: #6495ED;
            background: #f0f4ff;
        }

        .step.complete {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6495ED;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 18px;
        }

        .step.complete .step-number {
            background: #4caf50;
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .file-upload {
            margin: 15px 0;
        }

        .file-upload label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 500px;
        }

        input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 24px;
            background: white;
            border: 2px solid #6495ED;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #6495ED;
            box-shadow: 0 2px 8px rgba(100, 149, 237, 0.15);
        }

        .file-input-label:hover {
            background: #6495ED;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(100, 149, 237, 0.3);
        }

        .file-input-label svg {
            width: 20px;
            height: 20px;
        }

        .file-name-display {
            margin-top: 10px;
            padding: 8px 12px;
            background: #f0f4ff;
            border-radius: 6px;
            font-size: 13px;
            color: #4169E1;
            display: none;
        }

        .file-name-display.show {
            display: block;
        }

        .file-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }

        .file-status.success {
            display: block;
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .file-status.error {
            display: block;
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }

        .mapping-container {
            margin-top: 20px;
        }

        .mapping-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mapping-label {
            font-weight: 600;
            min-width: 150px;
            color: #333;
            font-size: 16px;
        }

        .mapping-select {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            max-width: 500px;
        }

        .mapping-select:focus {
            outline: none;
            border-color: #6495ED;
        }

        button {
            background: #6495ED;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #4169E1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(100, 149, 237, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .unmapped-list {
            margin-top: 15px;
            padding: 15px;
            background: #fff3e0;
            border-radius: 6px;
            border: 1px solid #ff9800;
        }

        .unmapped-list h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .unmapped-list ul {
            margin-left: 20px;
        }

        .unmapped-list li {
            color: #f57c00;
            margin: 5px 0;
        }

        .progress-info {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .match-item {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .match-item.matched {
            border-left: 4px solid #4caf50;
        }

        .match-item.unmatched {
            border-left: 4px solid #ff9800;
        }

        .match-column {
            display: flex;
            flex-direction: column;
        }

        .match-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .match-value {
            font-size: 14px;
            color: #333;
        }

        .match-arrow {
            text-align: center;
            font-size: 20px;
            color: #4caf50;
        }

        .match-arrow.unmatched {
            color: #ff9800;
        }

        .match-select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
        }

        .match-select:focus {
            outline: none;
            border-color: #6495ED;
        }

        .match-stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
        }

        .stat-item.success {
            background: #e8f5e9;
        }

        .stat-item.warning {
            background: #fff3e0;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .step-instructions {
            margin: 15px 0;
            padding-left: 20px;
            line-height: 1.6;
        }

        .step-instructions li {
            margin: 8px 0;
            color: #555;
        }

        .step-instructions b {
            color: #333;
        }

        .instruction-image {
            text-align: center;
            margin: 15px 0;
        }
    
        .instruction-image img {
            max-width: 600px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 6px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="faq.html" class="faq-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Help & FAQs
            </a>
            <h1>ðŸ“š NESA Course Mapping Tool</h1>
            <p>This tool maps class codes from Sentral to the course codes provided by NESA for use in Schools Online.</p>
        </div>

        <div class="construction-banner">
            <div class="banner-title">ðŸš§ This Page Is Still Under Construction! ðŸš§</div>
            <div class="banner-text">
                Features may be incomplete, unstable, or behave unpredictably.  
                Please use with caution and carefully review all generated files before relying on them.
            </div>
        </div>

        <!-- UNDER CONSTRUCTION BANNER START-->
        <style>
            .construction-banner {
                background: linear-gradient(135deg, #ffef9f, #ffd86b);
                border: 3px dashed #c47f00;
                padding: 20px;
                margin-bottom: 25px;
                text-align: center;
                border-radius: 10px;
                animation: wiggle 1.5s infinite ease-in-out;
            }
        
            .construction-banner .banner-title {
                font-size: 1.6rem;
                font-weight: bold;
                color: #8a4b00;
                margin-bottom: 8px;
            }
        
            .construction-banner .banner-text {
                font-size: 1rem;
                color: #5a3a00;
            }
        
            @keyframes wiggle {
                0% { transform: rotate(0deg); }
                25% { transform: rotate(1deg); }
                50% { transform: rotate(0deg); }
                75% { transform: rotate(-1deg); }
                100% { transform: rotate(0deg); }
            }
        </style>
        <!-- UNDER CONSTRUCTION BANNER END -->

        
        <div class="content">
            <!-- STEP 1: Upload Student Enrolments -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Upload Student Attendance Spreadsheet</div>
                </div>
            
                <ul class="step-instructions">
                    <li>Go to the <b>Profiles</b> module on Sentral.</li>
                    <li>Select <b>Exports</b> in the menu on the left.</li>
                    <li>Match the settings as shown below. Make sure you have selected only the desired year.</li>
                    <li>Only .xls or .xlsx files are accepted. Do not modify the spreadsheet once downloaded from Sentral.</li>
                </ul>

                <div class="instruction-image">
                    <img src="SentralSettings.png" alt="Sentral export settings screenshot" />
                </div>
            
                <div class="file-upload">
                    <label for="studentFile" style="font-weight: 600; color: #333; margin-bottom: 10px; display: block;">Select student attendance file (.xls or .xlsx):</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="studentFile" accept=".xls,.xlsx" />
                        <label for="studentFile" class="file-input-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span>Choose File</span>
                        </label>
                        <div class="file-name-display" id="studentFileName"></div>
                    </div>
                    <div class="file-status" id="studentStatus"></div>
                </div>
            
                <div class="progress-info" id="studentProgress"></div>
            </div>

            <!-- STEP 2: Upload NESA Course Codes -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Upload NESA Course Codes</div>
                </div>
            
                <ul class="step-instructions">
                    <li>In Schools Online, go to <b>Courses Offered at Your School</b>.</li>
                    <li>Change the year of study to the one you are working with.</li>
                    <li>Select <b>Show only courses offered</b>. This will show courses offered at your school and make matching easier.</li>
                    <li>Click on the download button. Do not make any changes to the file.</li>
                </ul>
            
                <div class="file-upload">
                    <label for="courseFile" style="font-weight: 600; color: #333; margin-bottom: 10px; display: block;">Select NESA course codes file (.csv):</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="courseFile" accept=".csv" />
                        <label for="courseFile" class="file-input-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span>Choose File</span>
                        </label>
                        <div class="file-name-display" id="courseFileName"></div>
                    </div>
                    <div class="file-status" id="courseStatus"></div>
                </div>
            
                <div class="progress-info" id="courseProgress"></div>
            </div>

            <!-- STEP 3: Upload NESA Template -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Upload NESA Template</div>
                </div>
            
                <ul class="step-instructions">
                    <li>In Schools Online, go to <b>20XX Enrolments</b>.</li>
                    <li>Select <b>Load Student Courses from a file</b>.</li>
                    <li>Make sure the correct year of study is selected.</li>
                    <li>On the left, click on <b>create entry file</b> to download the file. Do not make any changes to the file.</li>
                </ul>
            
                <div class="file-upload">
                    <label for="nesaStudentFile" style="font-weight: 600; color: #333; margin-bottom: 10px; display: block;">Select NESA student data file (.csv):</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="nesaStudentFile" accept=".csv" />
                        <label for="nesaStudentFile" class="file-input-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span>Choose File</span>
                        </label>
                        <div class="file-name-display" id="nesaStudentFileName"></div>
                    </div>
                    <div class="file-status" id="nesaStudentStatus"></div>
                </div>
            
                <div class="progress-info" id="nesaStudentProgress"></div>
            
                <div id="matchingContainer" class="hidden">
                    <div class="info-box" style="margin-top: 20px;">
                        Review automatic matches below. Unmatched students can be manually matched using the dropdowns.
                    </div>
                    <div id="matchingList"></div>
                    <button id="confirmMatchingBtn" onclick="confirmMatching()" style="margin-top: 20px;">
                        Confirm Matching & Continue
                    </button>
                </div>
            </div>

            <!-- STEP 4: Map Classes to Courses -->
            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Map Classes to NESA Courses</div>
                </div>
                <div class="info-box">
                    Map each unique class code to its corresponding NESA course. Most courses should do this automatically based on the class codes from Sentral and our database. Unmapped classes will retain their original names in the output. You will need to manually map any courses that were not automatically matched, and any Board Endorsed courses by using the textbox on the right of each course. For any classes on the timetable that do <i>not</i> need to be uploaded to Schools Online, click on the delete checkbox to remove it from the relevant students.
                </div>
                
                <!-- Year Level Selector -->
                <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        ðŸ“… Select Year Level (for auto-mapping):
                    </label>
                    <div style="display: flex; gap: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="yearLevel" value="10" id="year10" style="margin-right: 8px;">
                            <span>Year 10</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="yearLevel" value="11" id="year11" checked style="margin-right: 8px;">
                            <span>Year 11</span>
                        </label>
                    </div>
                    <button onclick="rerunAutoMapping()" style="margin-top: 10px; padding: 8px 20px; font-size: 14px;">
                        ðŸ”„ Re-run Auto-Mapping
                    </button>
                </div>
                
                <div class="mapping-container" id="mappingContainer"></div>
                <button id="generateBtn" onclick="generateOutput()" disabled>Generate Output Spreadsheet</button>
            </div>

            <!-- STEP 5: Download Output -->
            <div class="step" id="step5">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <div class="step-title">Download Output</div>
                </div>

                <p style="margin-bottom: 15px; line-height: 1.6; color: #555;">
                    Columns C, D and E are from the Sentral Attendance spreadsheet and are there for you to double check that the matching was done correctly. It is very important to check students with <i>common or duplicate surnames</i>. To upload this spreadsheet to Schools Online,
                </p>
                
                <ul class="step-instructions">
                    <li>Delete any students who do not have a NESA number. If you upload without doing this, Schools Online will get upset.</li>
                    <li>Delete columns C, D and E.</li>
                    <li>Do a final check for any courses that are still timetable codes instead of NESA codes.</li>
                    <li>Make sure the file is still a csv.</li>
                </ul>
                
                <div id="outputContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let studentData = null;
        let courseCodes = [];
        let nesaStudents = [];
        let studentMatching = {}; // Maps enrolment student index to NESA student index
        let uniqueClasses = [];
        let classMapping = {};
        let manuallyOverriddenClasses = new Set();
        let deletedClasses = new Set();


        // Step 1: Handle student enrolments upload
        document.getElementById('studentFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Show filename
            const fileNameDisplay = document.getElementById('studentFileName');
            fileNameDisplay.textContent = `ðŸ“„ ${file.name}`;
            fileNameDisplay.classList.add('show');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    // Process student data
                    studentData = processStudentData(jsonData);
                    
                    // Extract unique class names
                    uniqueClasses = extractUniqueClasses(studentData);
                    
                    // Show success
                    const status = document.getElementById('studentStatus');
                    status.className = 'file-status success';
                    status.textContent = `âœ“ Loaded ${studentData.students.length} students with ${uniqueClasses.length} unique classes`;
                    
                    const progress = document.getElementById('studentProgress');
                    progress.textContent = `Unique classes found: ${uniqueClasses.join(', ')}`;
                    
                    // Mark step complete and activate next
                    document.getElementById('step1').classList.add('complete');
                    document.getElementById('step2').classList.add('active');
                    
                } catch (error) {
                    const status = document.getElementById('studentStatus');
                    status.className = 'file-status error';
                    status.textContent = 'âœ— Error reading file: ' + error.message;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Step 2: Handle course codes upload
        document.getElementById('courseFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Show filename
            const fileNameDisplay = document.getElementById('courseFileName');
            fileNameDisplay.textContent = `ðŸ“„ ${file.name}`;
            fileNameDisplay.classList.add('show');

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    try {
                        courseCodes = results.data
                            .filter(row => row['Course Number'] && row['Course Name'])
                            .map(row => ({
                                number: row['Course Number'].trim(),
                                name: row['Course Name'].trim()
                            }));
                        
                        const status = document.getElementById('courseStatus');
                        status.className = 'file-status success';
                        status.textContent = `âœ“ Loaded ${courseCodes.length} NESA courses`;
                        
                        // Mark step complete and activate NESA student upload
                        document.getElementById('step2').classList.add('complete');
                        document.getElementById('step3').classList.add('active');
                        
                    } catch (error) {
                        const status = document.getElementById('courseStatus');
                        status.className = 'file-status error';
                        status.textContent = 'âœ— Error reading file: ' + error.message;
                    }
                },
                error: function(error) {
                    const status = document.getElementById('courseStatus');
                    status.className = 'file-status error';
                    status.textContent = 'âœ— Error parsing CSV: ' + error.message;
                }
            });
        });

        // Step 3: Handle NESA student data upload
        document.getElementById('nesaStudentFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Show filename
            const fileNameDisplay = document.getElementById('nesaStudentFileName');
            fileNameDisplay.textContent = `ðŸ“„ ${file.name}`;
            fileNameDisplay.classList.add('show');

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    try {
                        nesaStudents = results.data
                            .filter(row => row['NESA Student Id'] && row['Student Name'])
                            .map((row, index) => ({
                                originalIndex: index,
                                nesaId: row['NESA Student Id'].trim(),
                                name: row['Student Name'].trim(),
                                courses: [
                                    row['Course 1'], row['Course 2'], row['Course 3'], row['Course 4'], row['Course 5'],
                                    row['Course 6'], row['Course 7'], row['Course 8'], row['Course 9'], row['Course 10']
                                ].filter(c => c && c.trim())
                            }));
                        
                        const status = document.getElementById('nesaStudentStatus');
                        status.className = 'file-status success';
                        status.textContent = `âœ“ Loaded ${nesaStudents.length} NESA students`;
                        
                        // Perform automatic matching
                        performAutomaticMatching();
                        
                        // Show matching interface
                        document.getElementById('matchingContainer').classList.remove('hidden');
                        
                    } catch (error) {
                        const status = document.getElementById('nesaStudentStatus');
                        status.className = 'file-status error';
                        status.textContent = 'âœ— Error reading file: ' + error.message;
                    }
                },
                error: function(error) {
                    const status = document.getElementById('nesaStudentStatus');
                    status.className = 'file-status error';
                    status.textContent = 'âœ— Error parsing CSV: ' + error.message;
                }
            });
        });

        function performAutomaticMatching() {
            studentMatching = {};
            
            studentData.students.forEach((student, enrolIndex) => {
                // Parse enrolment name
                const enrolSurname = student.surname.trim().toLowerCase();
                const enrolFirstName = student.givenNames.trim().split(/\s+/)[0].toLowerCase(); // Get first word of given names
                
                // Try to find match in NESA data
                const matchIndex = nesaStudents.findIndex(nesaStudent => {
                    // Parse NESA name (format: "SURNAME, First Name")
                    const parts = nesaStudent.name.split(',');
                    if (parts.length !== 2) return false;
                    
                    const nesaSurname = parts[0].trim().toLowerCase();
                    const nesaFirstName = parts[1].trim().split(/\s+/)[0].toLowerCase(); // Get first word
                    
                    return nesaSurname === enrolSurname && nesaFirstName === enrolFirstName;
                });
                
                if (matchIndex !== -1) {
                    studentMatching[enrolIndex] = matchIndex;
                }
            });
            
            // Generate matching interface
            generateMatchingInterface();
        }

        function generateMatchingInterface() {
            const container = document.getElementById('matchingList');
            container.innerHTML = '';
            
            // Calculate stats
            const matchedCount = Object.keys(studentMatching).length;
            const unmatchedCount = studentData.students.length - matchedCount;
            
            // Add stats display with toggle button
            const statsWrapper = document.createElement('div');
            const stats = document.createElement('div');
            stats.className = 'match-stats';
            stats.innerHTML = `
                <div class="stat-item success">
                    <div class="stat-number" style="color: #2e7d32;">${matchedCount}</div>
                    <div class="stat-label">Automatically Matched</div>
                </div>
                <div class="stat-item warning">
                    <div class="stat-number" style="color: #e65100;">${unmatchedCount}</div>
                    <div class="stat-label">Need Manual Matching</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" style="color: #666;">${studentData.students.length}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            `;
            statsWrapper.appendChild(stats);
            
            // Add toggle button
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = 'ðŸ‘ï¸ Hide Matched Students';
            toggleBtn.style.marginTop = '10px';
            toggleBtn.id = 'toggleMatchedBtn';
            let showMatched = true;
            
            toggleBtn.onclick = function() {
                showMatched = !showMatched;
                const matchedItems = document.querySelectorAll('.match-item.matched');
                matchedItems.forEach(item => {
                    item.style.display = showMatched ? 'grid' : 'none';
                });
                toggleBtn.textContent = showMatched ? 'ðŸ‘ï¸ Hide Matched Students' : 'ðŸ‘ï¸ Show Matched Students';
            };
            
            statsWrapper.appendChild(toggleBtn);
            container.appendChild(statsWrapper);
            
            // Sort students: unmatched first, then matched
            const sortedStudents = studentData.students.map((student, index) => ({
                student,
                index,
                isMatched: studentMatching.hasOwnProperty(index)
            })).sort((a, b) => {
                // Unmatched (false) comes before matched (true)
                if (a.isMatched === b.isMatched) return 0;
                return a.isMatched ? 1 : -1;
            });
            
            // Generate matching items for each student
            sortedStudents.forEach(({ student, index: enrolIndex, isMatched }) => {
                const item = document.createElement('div');
                item.className = `match-item ${isMatched ? 'matched' : 'unmatched'}`;
                
                const enrolName = `${student.surname}, ${student.givenNames}`;
                const enrolId = student.studentId;
                
                // Left column: Enrolment data
                const leftCol = document.createElement('div');
                leftCol.className = 'match-column';
                leftCol.innerHTML = `
                    <div class="match-label">Enrolment File</div>
                    <div class="match-value"><strong>${enrolName}</strong></div>
                    <div class="match-value" style="font-size: 12px; color: #666;">ID: ${enrolId}</div>
                `;
                
                // Arrow
                const arrow = document.createElement('div');
                arrow.className = `match-arrow ${isMatched ? '' : 'unmatched'}`;
                arrow.textContent = isMatched ? 'âœ“ â†’' : '? â†’';
                
                // Right column: NESA match dropdown
                const rightCol = document.createElement('div');
                rightCol.className = 'match-column';
                rightCol.innerHTML = `<div class="match-label">NESA Student</div>`;
                
                const select = document.createElement('select');
                select.className = 'match-select';
                select.id = `match_${enrolIndex}`;
                
                // Add "No match" option
                const noMatchOption = document.createElement('option');
                noMatchOption.value = '';
                noMatchOption.textContent = '-- No NESA match --';
                select.appendChild(noMatchOption);
                
                // Add all NESA students as options
                nesaStudents.forEach((nesaStudent, nesaIndex) => {
                    const option = document.createElement('option');
                    option.value = nesaIndex;
                    option.textContent = `${nesaStudent.name} (${nesaStudent.nesaId})`;
                    if (isMatched && studentMatching[enrolIndex] === nesaIndex) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Update matching when selection changes
                select.addEventListener('change', function() {
                    if (this.value === '') {
                        delete studentMatching[enrolIndex];
                        item.className = 'match-item unmatched';
                        arrow.className = 'match-arrow unmatched';
                        arrow.textContent = '? â†’';
                    } else {
                        studentMatching[enrolIndex] = parseInt(this.value);
                        item.className = 'match-item matched';
                        arrow.className = 'match-arrow';
                        arrow.textContent = 'âœ“ â†’';
                    }
                    // Update stats
                    generateMatchingInterface();
                });
                
                rightCol.appendChild(select);
                
                // Status column
                const statusCol = document.createElement('div');
                statusCol.className = 'match-column';
                if (isMatched) {
                    const nesaStudent = nesaStudents[studentMatching[enrolIndex]];
                    statusCol.innerHTML = `
                        <div class="match-value" style="color: #2e7d32; font-weight: 600;">âœ“ Matched</div>
                        <div class="match-value" style="font-size: 11px; color: #666;">NESA ID: ${nesaStudent.nesaId}</div>
                    `;
                } else {
                    statusCol.innerHTML = `
                        <div class="match-value" style="color: #e65100; font-weight: 600;">âš  Needs Review</div>
                        <div class="match-value" style="font-size: 11px; color: #666;">Select NESA student</div>
                    `;
                }
                
                item.appendChild(leftCol);
                item.appendChild(arrow);
                item.appendChild(rightCol);
                item.appendChild(statusCol);
                container.appendChild(item);
            });
        }

        function confirmMatching() {
            // Mark step complete and activate class mapping
            document.getElementById('step3').classList.add('complete');
            document.getElementById('step4').classList.add('active');
            
            // Generate mapping interface
            generateMappingInterface();
            
            // Scroll to mapping section
            document.getElementById('step4').scrollIntoView({ behavior: 'smooth' });
        }

        function performAutomaticClassMapping() {
            
                const year10Selected = document.getElementById('year10').checked;
                const year11Selected = document.getElementById('year11').checked;
            
                const mappingHints = {
                    'MMA': ['mathematics advanced', 'advanced mathematics'],
                    'MMS': ['mathematics standard', 'standard mathematics'],
                    'MMX': ['mathematics extension', 'extension mathematics'],
                    'MXX': ['extension 2 mathematics', 'mathematics extension 2'],
            
                    'EEN': ['english', 'standard english', 'advanced english'],
                    'ENA': ['advanced english', 'english advanced'],
                    'ENS': ['standard english', 'english standard'],
                    'ENX': ['english extension', 'extension english'],
                    'EXX': ['extension 2 english', 'english extension 2'],
                    'ESL': ['english esl', 'esl'],
                    'EDR': ['drama'],
                    'DRA': ['drama'],
            
                    'SPH': ['physics'],
                    'SCH': ['chemistry'],
                    'SBI': ['biology'],
                    'SSC': ['science'],
                    'SEE': ['earth and environmental science', 'earth environmental'],
                    'SIS': ['investigating science'],
            
                    'HBS': ['business studies'],
                    'HLS': ['legal studies'],
                    'HAH': ['ancient history'],
                    'HMH': ['modern history', 'history'],
                    'HGE': ['geography'],
                    'HEC': ['economics'],
                    'HSC': ['society and culture'],
                    'HCA': ['community and family studies'],
                    'HWS': ['work studies'],
            
                    'CVA': ['visual arts', 'art'],
                    'CMU': ['music'],
                    'CDA': ['dance'],
                    'CDR': ['drama'],
            
                    'TDT': ['design and technology'],
                    'TFT': ['food technology'],
                    'TIT': ['industrial technology'],
                    'TTD': ['textiles and design'],
                    'TSW': ['software design', 'software'],
                    'TIM': ['information processes', 'ipt'],
                    'TAG': ['agriculture'],
                    'TES': ['engineering studies'],
            
                    'PPE': ['personal development', 'health', 'physical education', 'pdhpe'],
                    'PSP': ['sport lifestyle', 'sports'],
                    'PDA': ['dance']
            
                    'LFR': ['french'],
                    'LSP': ['spanish'],
                    'LGE': ['german'],
                    'LJP': ['japanese'],
                    'LCH': ['chinese'],
                    'LIT': ['italian'],
                    'LLA': ['latin'],
                    'LIN': ['indonesian'],
                    'LAR': ['arabic'],
            
                    'VET': ['vocational', 'vet'],
                    'VBU': ['business services'],
                    'VCO': ['construction'],
                    'VEN': ['entertainment'],
                    'VHO': ['hospitality'],
                    'VIT': ['information technology'],
                    'VRE': ['retail'],
            
                    'REL': ['studies of religion', 'religion'],
                    'SOR': ['studies of religion', 'religion'],
                    'PHO': ['photography']
                };
            
                window.autoMappings = {};
            
                uniqueClasses.forEach(className => {
            
                    const classUpper = className.toUpperCase();
            
                    if ((classUpper === 'MMX' || classUpper === 'ENX') && year10Selected) {
                        return;
                    }
            
                    const hints = mappingHints[classUpper];
                    if (!hints) return;
            
                    let potentialMatches = [];
            
                    courseCodes.forEach(course => {
                        const courseName = course.name.toLowerCase();
                        let score = 0;
            
                        hints.forEach(hint => {
                            if (courseName.includes(hint.toLowerCase())) {
                                score += hint.length;
                            }
                        });
            
                        if (score > 0) {
                            potentialMatches.push({
                                course: course,
                                score: score
                            });
                        }
                    });
            
                    if (potentialMatches.length === 0) return;
            
                    let bestMatch = null;
            
                    // YEAR 10: Prefer 200-hour
                    if (year10Selected) {
            
                        const matches200 = potentialMatches.filter(m =>
                            parseInt(m.course.hours) === 200
                        );
            
                        const pool = matches200.length > 0 ? matches200 : potentialMatches;
            
                        pool.sort((a, b) => b.score - a.score);
                        bestMatch = pool[0].course.number;
                    }
            
                    // YEAR 11: Prefer non-Life Skills
                    else if (year11Selected) {
            
                        const nonLifeSkills = potentialMatches.filter(m =>
                            !m.course.name.toLowerCase().includes('life skills')
                        );
            
                        const lifeSkills = potentialMatches.filter(m =>
                            m.course.name.toLowerCase().includes('life skills')
                        );
            
                        if (nonLifeSkills.length > 0) {
                            nonLifeSkills.sort((a, b) => b.score - a.score);
                            bestMatch = nonLifeSkills[0].course.number;
                        } else {
                            lifeSkills.sort((a, b) => b.score - a.score);
                            bestMatch = lifeSkills[0].course.number;
                        }
                    }
            
                    if (bestMatch) {
                        window.autoMappings[className] = bestMatch;
                    }
                });
            }


        function rerunAutoMapping() {
            // Clear previous auto-mappings
            window.autoMappings = {};
            
            // Re-run the auto-mapping with new year level
            performAutomaticClassMapping();
            
            // Update all the dropdowns with new mappings
            uniqueClasses.forEach(className => {
                const select = document.getElementById(`mapping_${className}`);
                if (!select) return;
                
                // Reset to default first
                select.value = '';
                
                // Apply new auto-mapping if it exists
                if (window.autoMappings && window.autoMappings[className]) {
                    select.value = window.autoMappings[className];
                }
            });
            
            // Update the info message
            const container = document.getElementById('mappingContainer');
            const existingInfo = container.querySelector('.info-box');
            if (existingInfo) {
                const autoMappedCount = uniqueClasses.filter(className => {
                    return window.autoMappings && window.autoMappings[className];
                }).length;
                
                if (autoMappedCount > 0) {
                    existingInfo.innerHTML = `âœ“ Automatically pre-selected ${autoMappedCount} of ${uniqueClasses.length} class mappings based on course names. Please review and adjust as needed.`;
                } else {
                    existingInfo.remove();
                }
            }
        }

        function processStudentData(jsonData) {
            const headers = jsonData[0];
            const students = [];
            
            // Find column indices
            const surnameIdx = headers.findIndex(h => h && h.toLowerCase().includes('surname'));
            const givenNameIdx = headers.findIndex(h => h && h.toLowerCase().includes('given'));
            const studentIdIdx = headers.findIndex(h => h && h.toLowerCase().includes('student id'));
            
            // Find class columns (skip attendance columns)
            const classColumns = [];
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i];
                if (header && header.toLowerCase().includes('class') && !header.toLowerCase().includes('attendance')) {
                    classColumns.push(i);
                }
            }
            
            // Process each student row
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row[surnameIdx]) continue; // Skip empty rows
                
                const student = {
                    surname: row[surnameIdx] || '',
                    givenNames: row[givenNameIdx] || '',
                    studentId: row[studentIdIdx] || '',
                    classes: []
                };
                
                // Extract classes (max 12)
                for (let j = 0; j < Math.min(classColumns.length, 12); j++) {
                    const classValue = row[classColumns[j]];
                    if (classValue && classValue.toString().trim()) {
                        student.classes.push(classValue.toString().trim());
                    }
                }
                
                students.push(student);
            }
            
            return { students, maxClasses: 12 };
        }

        function extractUniqueClasses(studentData) {
            const classSet = new Set();
            
            studentData.students.forEach(student => {
                student.classes.forEach(className => {
                    // Remove numbers to get unique class code
                    const cleanedClass = className.replace(/\d+/g, '');
                    if (cleanedClass) {
                        classSet.add(cleanedClass);
                    }
                });
            });
            
            return Array.from(classSet).sort();
        }

        function generateMappingInterface() {
            const container = document.getElementById('mappingContainer');
            container.innerHTML = '';
        
            manuallyOverriddenClasses = new Set();
            deletedClasses = new Set();
        
            performAutomaticClassMapping();
        
            uniqueClasses.forEach(className => {
                const item = document.createElement('div');
                item.className = 'mapping-item';
                item.id = `item_${className}`;
        
                const label = document.createElement('div');
                label.className = 'mapping-label';
                label.textContent = className;
        
                const select = document.createElement('select');
                select.className = 'mapping-select';
                select.id = `mapping_${className}`;
        
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Unmapped --';
                select.appendChild(defaultOption);
        
                courseCodes.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.number;
                    option.textContent = `${course.name} (${course.number})`;
                    if (window.autoMappings && window.autoMappings[className] === course.number) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
        
                const deleteWrapper = document.createElement('label');
                deleteWrapper.style.marginLeft = '15px';
                deleteWrapper.style.display = 'flex';
                deleteWrapper.style.alignItems = 'center';
        
                const deleteCheckbox = document.createElement('input');
                deleteCheckbox.type = 'checkbox';
                deleteCheckbox.id = `delete_${className}`;
                deleteCheckbox.style.marginRight = '5px';
        
                deleteWrapper.appendChild(deleteCheckbox);
                deleteWrapper.appendChild(document.createTextNode('Delete'));
        
                const manualInput = document.createElement('input');
                manualInput.type = 'text';
                manualInput.placeholder = 'Manual course code';
                manualInput.id = `manual_${className}`;
                manualInput.style.marginLeft = '15px';
                manualInput.style.padding = '8px';
                manualInput.style.borderRadius = '6px';
                manualInput.style.border = '2px solid #ddd';
                manualInput.style.width = '180px';
        
                function updateState() {
                    if (deleteCheckbox.checked) {
                        item.style.background = '#ffebee';
                        deletedClasses.add(className);
                        manuallyOverriddenClasses.delete(className);
                        select.value = '';
                        manualInput.value = '';
                    } else if (manualInput.value.trim()) {
                        item.style.background = '#e8f5e9';
                        manuallyOverriddenClasses.add(className);
                        deletedClasses.delete(className);
                        select.value = '';
                    } else if (select.value) {
                        item.style.background = '#e8f5e9';
                        deletedClasses.delete(className);
                        manuallyOverriddenClasses.delete(className);
                    } else {
                        item.style.background = '#fff3e0';
                        deletedClasses.delete(className);
                        manuallyOverriddenClasses.delete(className);
                    }
                }
        
                select.addEventListener('change', updateState);
                deleteCheckbox.addEventListener('change', updateState);
                manualInput.addEventListener('input', updateState);
        
                updateState();
        
                item.appendChild(label);
                item.appendChild(select);
                item.appendChild(deleteWrapper);
                item.appendChild(manualInput);
        
                container.appendChild(item);
            });
        
            document.getElementById('generateBtn').disabled = false;
        }


        function generateOutput() {
            
                classMapping = {};
            
                uniqueClasses.forEach(className => {
                    const select = document.getElementById(`mapping_${className}`);
                    const manualInput = document.getElementById(`manual_${className}`);
                    const deleteCheckbox = document.getElementById(`delete_${className}`);
            
                    if (deleteCheckbox && deleteCheckbox.checked) {
                        classMapping[className] = '';
                    } else if (manualInput && manualInput.value.trim()) {
                        classMapping[className] = manualInput.value.trim();
                    } else if (select && select.value) {
                        classMapping[className] = select.value;
                    } else {
                        classMapping[className] = className;
                    }
                });
            
                const outputData = [];
                const unmappedClasses = new Set();
                const unmatchedStudents = [];
            
                const headers = [
                    'NESA Student ID',
                    'Student Name (NESA)',
                    'Surname (Enrolment)',
                    'Given Names (Enrolment)',
                    'Student ID (Enrolment)'
                ];
            
                for (let i = 1; i <= studentData.maxClasses; i++) {
                    headers.push(`Class ${i}`);
                }
            
                outputData.push(headers);
            
                studentData.students.forEach((student, enrolIndex) => {
                    const row = [];
            
                    if (studentMatching.hasOwnProperty(enrolIndex)) {
                        const nesaStudent = nesaStudents[studentMatching[enrolIndex]];
                        row.push(nesaStudent.nesaId);
                        row.push(nesaStudent.name);
                    } else {
                        row.push('');
                        row.push('');
                        unmatchedStudents.push(`${student.surname}, ${student.givenNames}`);
                    }
            
                    row.push(student.surname);
                    row.push(student.givenNames);
                    row.push(student.studentId);
            
                    for (let i = 0; i < studentData.maxClasses; i++) {
                        if (i < student.classes.length) {
                            const originalClass = student.classes[i];
                            const cleanedClass = originalClass.replace(/\d+/g, '');
                            const mappedValue = classMapping[cleanedClass];
            
                            if (!mappedValue) {
                                row.push('');
                            } else {
                                row.push(mappedValue);
                                if (mappedValue === cleanedClass) {
                                    unmappedClasses.add(cleanedClass);
                                }
                            }
                        } else {
                            row.push('');
                        }
                    }
            
                    outputData.push(row);
                });
            
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(outputData);
                XLSX.utils.book_append_sheet(wb, ws, 'Mapped Students');
            
                XLSX.writeFile(wb, 'NESA_Mapped_Students.csv', { bookType: 'csv' });
            
                document.getElementById('step4').classList.add('complete');
                document.getElementById('step5').classList.add('active');
            
                const outputContainer = document.getElementById('outputContainer');
            
                let message = '<div class="info-box">âœ“ Output CSV generated successfully!</div>';
            
                if (unmatchedStudents.length > 0) {
                    message += '<div class="unmapped-list"><h4>âš ï¸ Unmatched Students</h4><ul>';
                    unmatchedStudents.forEach(s => message += `<li>${s}</li>`);
                    message += '</ul></div>';
                }
            
                if (unmappedClasses.size > 0) {
                    message += '<div class="unmapped-list"><h4>âš ï¸ Unmapped Classes</h4><ul>';
                    Array.from(unmappedClasses).forEach(c => message += `<li>${c}</li>`);
                    message += '</ul></div>';
                }
            
                if (manuallyOverriddenClasses.size > 0) {
                    message += '<div class="unmapped-list"><h4>âœï¸ Manually Overridden Classes</h4><ul>';
                    Array.from(manuallyOverriddenClasses).forEach(c => {
                        message += `<li>${c} â†’ ${classMapping[c]}</li>`;
                    });
                    message += '</ul></div>';
                }
            
                if (deletedClasses.size > 0) {
                    message += '<div class="unmapped-list"><h4>ðŸ—‘ Deleted Classes</h4><ul>';
                    Array.from(deletedClasses).forEach(c => {
                        message += `<li>${c}</li>`;
                    });
                    message += '</ul></div>';
                }
            
                message += '<button onclick="location.reload()">Start New Mapping</button>';
                outputContainer.innerHTML = message;
            }

    </script>
</body>
</html>
